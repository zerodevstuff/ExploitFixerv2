package dev._2lstudios.exploitfixer.utils;

import java.io.ByteArrayInputStream;
import java.io.DataInput;
import java.io.DataInputStream;
import java.io.IOException;
import java.nio.charset.Charset;

import com.github.steveice10.opennbt.NBTIO;
import com.github.steveice10.opennbt.tag.builtin.Tag;

import io.netty.buffer.ByteBuf;

public class PacketUtil {
    public static String readCustomPayload(ByteBuf buf) throws IOException {
        buf.readByte(); // Read the channel id
        if (!buf.isReadable()) return ""; // Check readability
        int length = buf.readByte(); // Read the length of the channel
        if (length <= 0 || !buf.isReadable(length)) return ""; // Check readability
        String channel = buf.toString(buf.readerIndex(), length, Charset.forName("utf-8")); // Read the channel
        buf.readerIndex(buf.readerIndex() + length);  // Increase reader index by length

        if (channel.equalsIgnoreCase("MC|BEdit")) {
            if (!buf.isReadable(5)) return ""; // Check readability
            buf.readBytes(5); // Space

            // Creating a byte array with enough capacity
            byte[] bytes = new byte[buf.readableBytes()];

            // Copying the readable bytes from the ByteBuf into the byte array
            buf.readBytes(bytes);

            // Parsing the byte array into an NBTTag object
            Tag nbt = NBTIO.readTag((DataInput) new DataInputStream(new ByteArrayInputStream(bytes)));

            // Return the values as String for checks
            return nbt.getValue().toString();
        }

        return "";
    }
}
