package dev._2lstudios.exploitfixer.listener;

import java.util.Collection;
import java.util.HashSet;

import org.bukkit.Location;
import org.bukkit.block.Block;
import org.bukkit.block.BlockFace;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.PlayerInventory;

import dev._2lstudios.exploitfixer.managers.ModuleManager;
import dev._2lstudios.exploitfixer.modules.NotificationsModule;
import dev._2lstudios.exploitfixer.modules.PatcherModule;
import dev._2lstudios.exploitfixer.utils.PlayerUtil;

public class PlayerInteractListener implements Listener {
    private PatcherModule patcherModule;
    private NotificationsModule notificationsModule;

    public PlayerInteractListener(ModuleManager moduleManager) {
        this.patcherModule = moduleManager.getPatcherModule();
        this.notificationsModule = moduleManager.getNotificationsModule();
    }

    @EventHandler(ignoreCancelled = true, priority = EventPriority.LOW)
    public void onPlayerInteract(PlayerInteractEvent event) {
        // Check if patching of duplication beds is enabled
        if (patcherModule.isBedDuplication()) {
            // Check if it's a right click block
            if (event.getAction() == Action.RIGHT_CLICK_BLOCK) {
                // Get player
                Player player = event.getPlayer();

                // Get player inventory
                PlayerInventory inventory = player.getInventory();

                // Get held item
                ItemStack heldItem = inventory.getItem(inventory.getHeldItemSlot());

                // Check if held item exists
                if (heldItem != null) {
                    // Get held item type name
                    String heldItemTypeName = heldItem.getType().name();

                    // Check if the held item is a bed
                    if (heldItemTypeName.endsWith("_BED") || heldItemTypeName.equals("BED")) {
                        // Get the clicked block
                        Block clickedBlock = event.getClickedBlock();

                        // Check if block exists
                        if (clickedBlock != null) {
                            // Get the block face of the event
                            BlockFace blockFace = event.getBlockFace();

                            // Create a collection of adjacent blocks
                            Collection<Block> adjacentBlocks = new HashSet<>();

                            // Location for searching adjacent blocks
                            Location searchLocation = clickedBlock.getLocation()
                                    .add(blockFace.getModX(), blockFace.getModY(), blockFace.getModZ());

                            // Search adjacent blocks
                            addAdjacent(adjacentBlocks, searchLocation); // Search

                            // Search adjacent to top-side of bed
                            BlockFace playerFacing = PlayerUtil.getFacing(player);
                            searchLocation.add(playerFacing.getModX(), playerFacing.getModY(), playerFacing.getModZ()); // Align
                            addAdjacent(adjacentBlocks, searchLocation); // Search

                            for (Block block : adjacentBlocks) {
                                // Get the name of the type of the block
                                String blockTypeName = block.getType().name();

                                // Check if the block is a growing crop
                                if (blockTypeName.equals("WHEAT") || blockTypeName.equals("POTATOES")
                                        || blockTypeName.equals("POTATO") || blockTypeName.equals("CARROTS")
                                        || blockTypeName.equals("CARROT") || blockTypeName.equals("NETHER_WARTS")
                                        || blockTypeName.equals("BEETROOTS")) {
                                    // Cancel the event
                                    event.setCancelled(true);
                                    // Notify
                                    notificationsModule.debug("[Patcher] Player " + event.getPlayer().getName()
                                            + " is trying to duplicate crops with beds.");
                                    // Break
                                    break;
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    private void addAdjacent(Collection<Block> adjacentBlocks, Location searchLocation) {
        adjacentBlocks.add(searchLocation.add(0, -1, 0).getBlock()); // Down
        adjacentBlocks.add(searchLocation.add(0, 2, 0).getBlock()); // Up
        adjacentBlocks.add(searchLocation.add(-1, -1, 0).getBlock()); // Left
        adjacentBlocks.add(searchLocation.add(2, 0, 0).getBlock()); // Right
        adjacentBlocks.add(searchLocation.add(-1, 0, 1).getBlock()); // Forward
        adjacentBlocks.add(searchLocation.add(0, 0, -2).getBlock()); // Downward
        searchLocation.add(0, 0, 1); // Align
    }
}
