package dev._2lstudios.exploitfixer.listener;

import org.bukkit.World;
import org.bukkit.block.Block;
import org.bukkit.block.BlockState;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.world.StructureGrowEvent;

import dev._2lstudios.exploitfixer.managers.ModuleManager;
import dev._2lstudios.exploitfixer.modules.PatcherModule;
import dev._2lstudios.exploitfixer.modules.NotificationsModule;

public class StructureGrowListener implements Listener {
    private NotificationsModule notificationsModule;
    private PatcherModule eventsModule;

    StructureGrowListener(ModuleManager moduleManager) {
        this.notificationsModule = moduleManager.getNotificationsModule();
        this.eventsModule = moduleManager.getPatcherModule();
    }

    @EventHandler(priority = EventPriority.LOW, ignoreCancelled = true)
    public void onStructureGrow(StructureGrowEvent event) {
        if (eventsModule.isEnderPortalBreak()) {
            World world = event.getWorld();

            for (BlockState blockBefore : event.getBlocks()) {
                Block block = world.getBlockAt(blockBefore.getLocation());
                String type = block.getType().name();

                if (type.contains("ENDER_PORTAL")
                        || type.contains("END_PORTAL") || type.contains("END_GATEWAY")) {
                    event.setCancelled(true);
                    notificationsModule.debug("[Patcher|EnderPortalBreak] A mushroom tried to break an end portal.");
                }
            }
        }
    }
}
