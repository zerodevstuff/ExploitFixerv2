package dev._2lstudios.exploitfixer.listener;

import org.bukkit.Chunk;
import org.bukkit.Location;
import org.bukkit.World;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerMoveEvent;

import dev._2lstudios.exploitfixer.managers.ModuleManager;
import dev._2lstudios.exploitfixer.modules.PatcherModule;
import dev._2lstudios.exploitfixer.modules.NotificationsModule;

public class PlayerMoveListener implements Listener {
	private NotificationsModule notificationsModule;
	private PatcherModule eventsModule;

	PlayerMoveListener(ModuleManager moduleManager) {
		this.notificationsModule = moduleManager.getNotificationsModule();
		this.eventsModule = moduleManager.getPatcherModule();
	}

	@EventHandler(priority = EventPriority.LOWEST, ignoreCancelled = true)
	public void onPlayerMove(PlayerMoveEvent event) {
		Player player = event.getPlayer();

		if (eventsModule.isGodMode()) {
			if (player.isInsideVehicle() && !player.getVehicle().isValid()) {
				player.getVehicle().eject();
			}

			if (!player.isValid() && !player.isDead()) {
				player.kickPlayer("Disconnected (Invalid Movement?)");
			}
		}

		if (eventsModule.isNullChunk()) {
			Location to = event.getTo();
			World world = to.getWorld();
			Chunk chunk = to.getChunk();

			if (chunk == null || !world.isChunkLoaded(chunk)) {
				event.setCancelled(true);
				notificationsModule
						.debug("[Patcher] Cancelled movement to null chunk by " + player.getName() + "!");
			}
		}
	}
}
